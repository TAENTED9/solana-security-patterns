name: Solana Security Patterns CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  SOLANA_VERSION: '2.1.15'
  ANCHOR_VERSION: '0.32.1'
  RUST_VERSION: '1.85.0'

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt
          override: true
      
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Lints
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy
          override: true
      
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ env.RUST_VERSION }}
          override: true
      
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      
      - name: Run security audit
        run: cargo audit

  license-check:
    name: License & Advisory Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ env.RUST_VERSION }}
          override: true
      
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      
      - name: Run cargo-deny
        run: cargo deny check

  build-examples:
    name: Build All Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ env.RUST_VERSION }}
          override: true
      
      - name: Install Solana
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      
      - name: Install Anchor
        run: |
          cargo install --git https://github.com/coral-xyz/anchor --tag v${{ env.ANCHOR_VERSION }} anchor-cli --locked
      
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build Example 01
        working-directory: examples/01-missing-account-validation
        run: anchor build
      
      # Add more examples as they are completed
      # - name: Build Example 02
      #   working-directory: examples/02-signer-authorization
      #   run: anchor build
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            examples/*/target/deploy/*.so
            examples/*/target/idl/*.json

  test-examples:
    name: Test All Examples
    runs-on: ubuntu-latest
    needs: build-examples
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: ${{ env.RUST_VERSION }}
          override: true
      
      - name: Install Solana
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      
      - name: Install Anchor
        run: |
          cargo install --git https://github.com/coral-xyz/anchor --tag v${{ env.ANCHOR_VERSION }} anchor-cli --locked
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install Yarn
        run: npm install -g yarn
      
      - name: Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
            node_modules/
          key: ${{ runner.os }}-deps-${{ hashFiles('**/Cargo.lock', '**/yarn.lock') }}
      
      - name: Test Example 01
        working-directory: examples/01-missing-account-validation
        run: |
          yarn install
          anchor test
        env:
          ANCHOR_WALLET: ~/.config/solana/id.json
      
      # Add more examples as they are completed
      # - name: Test Example 02
      #   working-directory: examples/02-signer-authorization
      #   run: |
      #     yarn install
      #     anchor test

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check documentation files exist
        run: |
          test -f README.md
          test -f LICENSE
          test -f docs/deep-dive.md
          test -f docs/research-summary.md
          test -f docs/references.md
      
      - name: Check for broken links (basic)
        run: |
          # Basic check for common broken link patterns
          ! grep -r "](http://localhost" docs/ README.md || exit 1
          ! grep -r "](file://" docs/ README.md || exit 1
      
      - name: Validate Markdown
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: '**/*.md'

  vulnerable-code-warning:
    name: Verify Vulnerable Code Warnings
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check vulnerable examples have warnings
        run: |
          # Verify each vulnerable example has clear warning comments
          for dir in examples/*/programs/vulnerable/src/*.rs; do
            if [ -f "$dir" ]; then
              if ! grep -q "VULNERABLE" "$dir"; then
                echo "ERROR: $dir missing VULNERABLE warning"
                exit 1
              fi
            fi
          done
      
      - name: Check README has disclaimer
        run: |
          if ! grep -q "intentionally vulnerable" README.md; then
            echo "ERROR: README.md missing vulnerability disclaimer"
            exit 1
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [format, clippy, security-audit, license-check, build-examples, test-examples, documentation, vulnerable-code-warning]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Format: ${{ needs.format.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Clippy: ${{ needs.clippy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- License Check: ${{ needs.license-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build-examples.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test-examples.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation: ${{ needs.documentation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerable Warnings: ${{ needs.vulnerable-code-warning.result }}" >> $GITHUB_STEP_SUMMARY
